<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport">
    <title>Focus App - Secure Proxy Edition</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Инициализация Telegram WebApp в самом начале для корректного expand()
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        tg.enableClosingConfirmation();
        
        // Fullscreen будет запрошен при нажатии кнопки Start
        function requestFullscreenMode() {
            try {
                if (tg.requestFullscreen) {
                    tg.requestFullscreen();
                }
            } catch (e) { console.log('Fullscreen not supported:', e); }
        }
    </script>
    
    <!-- Manrope Font -->
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Manrope', 'sans-serif'] },
                    colors: {
                        'brand-black': '#0a0a0a',
                        'brand-dark': '#121212',
                        'brand-gray': '#1e1e1e',
                        'brand-green': '#00dc82',
                        'brand-red': '#ef4444',
                    },
                    animation: {
                        'breathing': 'breathing 4s ease-in-out infinite',
                    },
                    keyframes: {
                        breathing: {
                            '0%, 100%': { transform: 'scale(1)', opacity: '0.8' },
                            '50%': { transform: 'scale(1.1)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* New Premium Animations */
        @keyframes enter-up {
            0% { opacity: 0; transform: translateY(30px) scale(0.95); filter: blur(10px); }
            100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
        }
        @keyframes pulse-glow {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }
        @keyframes float-icon {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .animate-enter-up { animation: enter-up 1s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }
        .delay-300 { animation-delay: 0.3s; }
        
        body {
            background-color: #1e293b; 
            color: #f5f5f5;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            transition: background-color 0.5s ease;
            user-select: none;
            font-family: 'Manrope', sans-serif;
        }
        
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        .glass-panel {
            background: rgba(30, 30, 30, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .task-card {
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s;
        }
        .task-card:active { transform: scale(0.96); }
        
        /* Language Toggle Switch */
        .lang-switch {
            background: rgba(255,255,255,0.1);
            border-radius: 99px;
            padding: 4px;
            display: flex;
            position: relative;
        }
        .lang-option {
            flex: 1;
            text-align: center;
            padding: 6px 0;
            font-size: 12px;
            font-weight: 800;
            z-index: 2;
            transition: color 0.3s;
            cursor: pointer;
        }
        .lang-active-bg {
            position: absolute;
            top: 4px; bottom: 4px;
            width: 50%;
            background: #00dc82;
            border-radius: 99px;
            z-index: 1;
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        
        @keyframes breathe-cycle {
            0% { transform: scale(1); opacity: 0.8; box-shadow: 0 0 30px rgba(0,220,130,0.3); }
            33.33% { transform: scale(1.6); opacity: 1; box-shadow: 0 0 80px rgba(0,220,130,0.6); }
            66.66% { transform: scale(1.6); opacity: 1; box-shadow: 0 0 80px rgba(0,220,130,0.6); }
            100% { transform: scale(1); opacity: 0.8; box-shadow: 0 0 30px rgba(0,220,130,0.3); }
        }
        
        .paused { animation-play-state: paused !important; }
        
        /* Voice Recording Progress Ring */
        .voice-btn-container {
            position: relative;
            width: 80px;
            height: 80px;
        }
        .progress-ring {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            -webkit-transform: rotate(270deg);
            transform: rotate(270deg);
            pointer-events: none;
        }
        .progress-ring__circle {
            fill: transparent;
            stroke: #00dc82;
            stroke-width: 3;
            stroke-linecap: round;
            stroke-dasharray: 226, 226;
            stroke-dashoffset: 226;
            -webkit-transition: stroke-dashoffset 0.1s linear;
            transition: stroke-dashoffset 0.1s linear;
        }
        .progress-ring__circle.animating {
            -webkit-animation: progress-countdown 8s linear forwards;
            animation: progress-countdown 8s linear forwards;
        }
        @-webkit-keyframes progress-countdown {
            from { stroke-dashoffset: 226; }
            to { stroke-dashoffset: 0; }
        }
        @keyframes progress-countdown {
            from { stroke-dashoffset: 226; }
            to { stroke-dashoffset: 0; }
        }
        .progress-ring__bg {
            fill: transparent;
            stroke: rgba(255, 255, 255, 0.1);
            stroke-width: 3;
        }
    </style>
</head>
<body class="h-screen w-full overflow-hidden relative flex flex-col items-center" id="app-body" oncontextmenu="return false;">
    
    <!-- START SCREEN (для запуска fullscreen по user gesture) -->
    <div id="start-screen" class="fixed inset-0 z-[200] flex flex-col items-center justify-center bg-[#050505] overflow-hidden">
        
        <div class="absolute inset-0 pointer-events-none">
            <div class="absolute top-[-20%] left-1/2 -translate-x-1/2 w-[800px] h-[800px] bg-brand-green/10 rounded-full blur-[120px] animate-[pulse-glow_8s_ease-in-out_infinite]"></div>
            <div class="absolute bottom-[-10%] left-1/2 -translate-x-1/2 w-[600px] h-[400px] bg-brand-green/5 rounded-full blur-[100px]"></div>
        </div>



        <div class="relative z-10 flex flex-col items-center">
            
            <!-- Animated Icon Group -->
            <div class="relative mb-12 animate-enter-up">
                <!-- Outer Rings -->
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-48 h-48 border border-brand-green/10 rounded-full animate-[spin-slow_20s_linear_infinite]"></div>
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-36 h-36 border border-brand-green/20 rounded-full animate-[spin-slow_15s_linear_infinite_reverse]"></div>
                
                <!-- Glow -->
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-24 h-24 bg-brand-green/20 blur-xl rounded-full animate-pulse"></div>
                
                <!-- Icon Card -->
                <div class="relative w-24 h-24 rounded-3xl bg-gradient-to-br from-[#1a1a1a] to-[#0a0a0a] border border-white/10 shadow-[0_0_50px_rgba(0,220,130,0.2)] flex items-center justify-center animate-[float-icon_6s_ease-in-out_infinite]">
                    <span class="material-symbols-outlined text-brand-green text-5xl drop-shadow-[0_0_15px_rgba(0,220,130,0.6)]">target</span>
                </div>
            </div>

            <!-- Typography -->
            <div class="flex flex-col items-center gap-3 mb-12 animate-enter-up delay-100">
                <h1 class="text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-b from-white via-white/90 to-white/50 tracking-tighter drop-shadow-lg">Focus</h1>
                <p class="text-brand-green/80 text-sm font-bold uppercase tracking-[0.2em] shadow-black drop-shadow-md">AI-Powered Clarity</p>
            </div>

            <!-- Primary Action -->
            <button id="start-btn" onclick="startApp()" class="group relative px-12 py-5 rounded-full overflow-hidden transition-all duration-300 active:scale-95 animate-enter-up delay-200 shadow-[0_0_30px_rgba(0,220,130,0.2)] hover:shadow-[0_0_50px_rgba(0,220,130,0.5)]">
                <div class="absolute inset-0 bg-brand-green opacity-90 transition-opacity group-hover:opacity-100"></div>
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000"></div>
                
                <div class="relative flex items-center gap-3">
                    <span class="text-brand-black font-extrabold text-lg tracking-wide">ENTER APP</span>
                    <span class="material-symbols-outlined text-brand-black group-hover:translate-x-1 transition-transform">arrow_forward</span>
                </div>
            </button>
            
        </div>

        <!-- Footer -->
        <div class="absolute bottom-8 animate-enter-up delay-300">
             <p class="text-white/20 text-[10px] uppercase tracking-[0.3em]">Minimalist Productivity</p>
        </div>

    </div>

    <div class="w-full max-w-md flex flex-col h-full relative">
        
        <!-- HEADER -->
        <header class="w-full z-20 flex flex-col bg-gradient-to-b from-black/80 via-black/40 to-transparent pb-4 relative pt-4">
            <div class="w-full h-[58px] shrink-0" id="header-spacer"></div> 

            <div class="w-full flex justify-center items-center mb-4 relative z-30">
                <h1 class="text-2xl font-extrabold tracking-tight text-white select-none hover:text-brand-green transition-colors cursor-pointer flex items-center gap-2" onclick="openBreathingModal()" id="focus-title-btn">
                    Focus
                    <span class="w-2 h-2 rounded-full bg-brand-green animate-pulse hidden" id="ping-indicator"></span>
                </h1>
            </div>

            <div class="px-4 flex justify-between items-center w-full mb-4 z-30">
                <button onclick="toggleSettingsModal(); haptic('light')" class="flex items-center gap-2 glass-panel px-4 py-2 rounded-full hover:bg-white/10 transition-colors active:scale-95 group">
                    <span class="material-symbols-outlined text-[18px] text-gray-300 group-hover:text-white">settings</span>
                    <span class="text-[10px] font-bold uppercase tracking-wider text-gray-300 group-hover:text-white" id="lbl-settings">SETTINGS</span>
                </button>

                <button class="flex items-center gap-2 glass-panel px-4 py-2 rounded-full select-none active:scale-95 transition-transform" id="status-container">
                    <div class="w-2 h-2 rounded-full bg-brand-green animate-pulse" id="status-dot"></div>
                    <span class="text-[10px] font-bold uppercase tracking-wider text-gray-300" id="agent-status-text">AGENT</span>
                </button>
            </div>

            <nav class="flex p-1 bg-brand-gray/50 rounded-2xl relative mx-4 border border-white/5 shadow-inner">
                <div class="absolute top-1 bottom-1 left-1 w-[32%] bg-brand-green rounded-xl transition-all duration-300 ease-out z-0" id="tab-indicator" style="transform: translateX(0%);"></div>
                <button class="flex-1 relative z-10 py-2.5 text-[11px] font-extrabold text-center transition-colors duration-300 text-brand-black" id="btn-Task" onclick="switchTab('Task')">TASK</button>
                <button class="flex-1 relative z-10 py-2.5 text-[11px] font-extrabold text-center transition-colors duration-300 text-gray-400" id="btn-Long" onclick="switchTab('Long')">LONG</button>
                <button class="flex-1 relative z-10 py-2.5 text-[11px] font-extrabold text-center transition-colors duration-300 text-gray-400" id="btn-Routine" onclick="switchTab('Routine')">ROUTINE</button>
            </nav>
        </header>

        <!-- MAIN -->
        <main class="flex-1 overflow-y-auto w-full px-4 pb-36 scroll-smooth" id="main-scroll">
            <div class="grid grid-cols-2 gap-3 auto-rows-min pt-2" id="task-grid"></div>
            
            <div class="hidden flex flex-col items-center justify-center h-64 opacity-30" id="empty-state">
                <span class="material-symbols-outlined text-5xl mb-2">mic</span>
                <p class="text-sm font-semibold" id="lbl-tap">Tap to speak</p>
            </div>
        </main>

        <!-- VOICE BUTTON -->
        <div class="absolute bottom-0 left-0 w-full h-36 bg-gradient-to-t from-black via-black/80 to-transparent pointer-events-none flex justify-center items-end pb-10 z-30">
            <div class="pointer-events-auto voice-btn-container">
                <svg class="progress-ring" viewBox="0 0 80 80">
                    <circle class="progress-ring__bg" cx="40" cy="40" r="36"/>
                    <circle class="progress-ring__circle" id="progress-circle" cx="40" cy="40" r="36"/>
                </svg>
                <button class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-16 h-16 rounded-full bg-brand-green flex items-center justify-center shadow-[0_0_25px_rgba(0,220,130,0.4)] transition-all duration-300 transform active:scale-90 overflow-hidden border-2 border-white/10" id="voice-btn">
                    <span class="material-symbols-outlined text-brand-black text-3xl z-10" id="mic-icon">mic</span>
                    <div class="absolute inset-0 flex items-center justify-center gap-1 hidden" id="waveform">
                        <div class="w-1 bg-brand-black/80 animate-pulse h-4"></div>
                        <div class="w-1 bg-brand-black/80 animate-pulse h-7" style="animation-delay:0.1s"></div>
                        <div class="w-1 bg-brand-black/80 animate-pulse h-3" style="animation-delay:0.2s"></div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div class="fixed inset-0 z-[60] flex items-center justify-center pointer-events-none opacity-0 hidden transition-opacity duration-200" id="settings-modal">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-md pointer-events-auto" onclick="toggleSettingsModal()"></div>
        <div class="bg-brand-gray border border-brand-green/30 w-[90%] max-w-sm rounded-3xl p-6 relative pointer-events-auto transform scale-95 transition-transform duration-200">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-white" id="lbl-modal-settings">Settings</h2>
                <button onclick="toggleSettingsModal()" class="text-gray-400"><span class="material-symbols-outlined">close</span></button>
            </div>
            <div class="mb-6">
                <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider mb-2" id="lbl-language">Language</p>
                <div class="lang-switch" onclick="toggleLanguage()">
                    <div class="lang-active-bg" id="lang-bg"></div>
                    <div class="lang-option text-brand-black" id="lang-en">English</div>
                    <div class="lang-option text-gray-400" id="lang-ru">Русский</div>
                </div>
            </div>
            <div class="mb-6">
                <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider mb-2" id="lbl-theme">Theme</p>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="setTheme(0)" class="h-10 rounded-xl bg-[#1e293b] border-2 border-white/20 hover:border-brand-green transition-colors"></button>
                    <button onclick="setTheme(1)" class="h-10 rounded-xl bg-[#052e16] border-2 border-white/20 hover:border-brand-green transition-colors"></button>
                    <button onclick="setTheme(2)" class="h-10 rounded-xl bg-[#042f2e] border-2 border-white/20 hover:border-brand-green transition-colors"></button>
                    <button onclick="setTheme(3)" class="h-10 rounded-xl bg-[#1e1b4b] border-2 border-white/20 hover:border-brand-green transition-colors"></button>
                </div>
            </div>
        </div>
    </div>

    <!-- BREATHING MODAL -->
    <div class="fixed inset-0 z-[70] flex items-center justify-center bg-brand-black/95 backdrop-blur-xl opacity-0 pointer-events-none transition-opacity duration-500" id="breathing-modal">
        <button onclick="closeBreathingModal()" class="absolute top-6 right-6 p-4 text-gray-400 hover:text-white transition-colors z-20 active:scale-95">
            <span class="material-symbols-outlined text-3xl">close</span>
        </button>
        
        <div class="flex flex-col items-center justify-center w-full h-full relative z-10 p-6">
            <div class="relative flex items-center justify-center mb-20">
                <div class="absolute w-64 h-64 rounded-full bg-brand-green/5 animate-pulse"></div>
                <div class="absolute w-48 h-48 rounded-full bg-brand-green/10 animate-pulse delay-75"></div>
                
                <div id="breath-circle" onclick="toggleBreathPause()" class="w-32 h-32 rounded-full bg-gradient-to-br from-brand-green to-emerald-600 shadow-[0_0_50px_rgba(0,220,130,0.4)] flex items-center justify-center z-10 transform transition-transform duration-75 cursor-pointer active:scale-95">
                    <span class="material-symbols-outlined text-brand-black text-5xl opacity-75">spa</span>
                </div>
            </div>
            
            <!-- PAUSE MENU -->
            <div id="breath-pause-menu" class="absolute inset-0 z-50 flex items-center justify-center hidden opacity-0 transition-all duration-300 backdrop-blur-sm bg-black/40">
                 <div class="glass-panel p-6 rounded-3xl flex flex-col gap-3 w-48 shadow-2xl transform scale-90 transition-transform duration-300" id="breath-menu-card">
                    <button onclick="resumeBreathing()" class="bg-brand-green text-brand-black font-extrabold py-3 rounded-xl hover:opacity-90 active:scale-95 transition-all shadow-lg shadow-brand-green/20" id="btn-breath-continue">
                        Continue
                    </button>
                    <button onclick="exitBreathing()" class="bg-white/10 text-white/80 font-bold py-3 rounded-xl hover:bg-white/20 active:scale-95 transition-all" id="btn-breath-exit">
                        Exit
                    </button>
                </div>
            </div>

            <div class="text-center h-24 flex flex-col items-center justify-center z-20">
                <h2 id="breath-text" class="text-3xl font-extrabold text-white tracking-tight mb-1 transition-all duration-300">Get Ready</h2>
                <p id="breath-subtext" class="text-brand-green font-bold uppercase tracking-widest text-xs opacity-80">Relax</p>
            </div>
            
            <div class="absolute bottom-12 w-full max-w-xs px-6">
                <div class="flex justify-between text-[10px] font-bold uppercase tracking-wider text-gray-500 mb-2">
                    <span id="breath-cycle-count">Cycle 1/5</span>
                    <span>1 min</span>
                </div>
                <div class="w-full h-1.5 bg-white/10 rounded-full overflow-hidden">
                    <div id="breath-progress" class="h-full bg-brand-green shadow-[0_0_10px_brand-green] w-0"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ACTION SHEET -->
    <div class="fixed inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none opacity-0 transition-opacity duration-300" id="action-modal">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-md pointer-events-auto" id="action-backdrop" onclick="closeModal()"></div>
        <div class="bg-brand-gray border border-white/10 w-full max-w-sm rounded-t-3xl sm:rounded-3xl p-6 transform translate-y-full transition-transform duration-300 ease-out pointer-events-auto shadow-2xl" id="action-sheet">
            <div class="w-12 h-1 bg-white/20 rounded-full mx-auto mb-6"></div>
            <h3 class="text-xl font-bold text-white mb-1" id="modal-task-title">Title</h3>
            <p class="text-[10px] text-gray-500 mb-6 italic truncate" id="modal-original-command">Original</p>
            <div class="grid grid-cols-2 gap-3">
                <button class="col-span-2 bg-brand-green text-brand-black font-extrabold py-4 rounded-2xl flex items-center justify-center gap-2 active:scale-95 transition-transform" onclick="taskAction('done')">
                    <span class="material-symbols-outlined">check_circle</span> <span id="lbl-done">Done</span>
                </button>
                <button class="bg-white/5 border border-white/10 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 active:scale-95 transition-transform" onclick="taskAction('up')">
                    <span class="material-symbols-outlined">arrow_upward</span> <span id="lbl-prio">Priority</span>
                </button>
                <button class="bg-white/5 border border-white/10 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 active:scale-95 transition-transform" onclick="taskAction('down')">
                    <span class="material-symbols-outlined">arrow_downward</span> <span id="lbl-lower">Lower</span>
                </button>
                <button class="col-span-2 text-red-400 font-bold py-3 rounded-xl flex items-center justify-center gap-2 active:scale-95 transition-transform text-xs" onclick="taskAction('delete')">
                    <span class="material-symbols-outlined text-lg">delete</span> <span id="lbl-delete">Delete</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // BREATHING EXERCISE LOGIC
        let breathInterval;
        let breathTimer;
        let breathElapsed = 0;
        let currentBreathCycle = null;
        
        function openBreathingModal() {
            const m = document.getElementById('breathing-modal');
            const circle = document.getElementById('breath-circle');
            const text = document.getElementById('breath-text');
            const sub = document.getElementById('breath-subtext');
            const progress = document.getElementById('breath-progress');
            const countText = document.getElementById('breath-cycle-count');
            const t = i18n[state.language];
            
            m.classList.remove('pointer-events-none');
            m.classList.remove('opacity-0');
            
            haptic('light');
            
            // Reset state
            progress.style.transition = 'none';
            progress.style.width = '0%';
            
            // Ensure pause menu is hidden
            document.getElementById('breath-pause-menu').classList.add('hidden', 'opacity-0');
            document.getElementById('breath-menu-card').classList.add('scale-90');
            circle.classList.remove('paused');
            
            text.innerText = t.breath_ready;
            sub.innerText = t.breath_relax;
            countText.innerText = t.breath_ready;
            circle.style.animation = 'none';
            
            // Initial delay before start
            if (breathTimer) clearTimeout(breathTimer);
            if (breathInterval) clearInterval(breathInterval);
            
            breathTimer = setTimeout(() => {
                startBreathingLoop();
            }, 1000);
        }

        function startBreathingLoop() {
            const circle = document.getElementById('breath-circle');
            const text = document.getElementById('breath-text');
            const sub = document.getElementById('breath-subtext');
            const progress = document.getElementById('breath-progress');
            const countText = document.getElementById('breath-cycle-count');
            const t = i18n[state.language];
            
            // Ensure no pause state
            circle.classList.remove('paused');
            document.getElementById('breath-pause-menu').classList.add('hidden', 'opacity-0');
            
            // Apply animation class
            circle.style.animation = 'breathe-cycle 12s ease-in-out infinite';
            
            const totalTime = 60;
            breathElapsed = 0;
            
            // Start progress bar
            progress.style.transition = `width ${totalTime}s linear`;
            progress.style.width = '100%';
            
            // Cycle logic
            currentBreathCycle = () => {
                if (breathElapsed >= totalTime) {
                    finishBreathing();
                    return;
                }

                const cycleTime = breathElapsed % 12; // 0-11
                const currentCycle = Math.floor(breathElapsed / 12) + 1;
                countText.innerText = `${t.breath_cycle} ${currentCycle}/5`;
                
                if (cycleTime < 4) {
                    // Inhale (0-4s)
                    text.innerText = t.breath_in;
                    text.className = "text-3xl font-extrabold text-white tracking-tight mb-1 transition-all duration-300 scale-110";
                    sub.innerText = t.breath_expand;
                    if (cycleTime === 0) haptic('medium');
                } else if (cycleTime < 8) {
                    // Hold (4-8s)
                    text.innerText = t.breath_hold;
                    text.className = "text-3xl font-extrabold text-white/80 tracking-tight mb-1 transition-all duration-300";
                    sub.innerText = t.breath_keep;
                    if (cycleTime === 4) haptic('selection');
                } else {
                    // Exhale (8-12s)
                    text.innerText = t.breath_out;
                    text.className = "text-3xl font-extrabold text-brand-green tracking-tight mb-1 transition-all duration-300 scale-95";
                    sub.innerText = t.breath_release;
                    if (cycleTime === 8) haptic('light');
                }
                
                breathElapsed++;
            };
            
            currentBreathCycle(); // Run immediately
            breathInterval = setInterval(currentBreathCycle, 1000);
        }
        
        function finishBreathing() {
            clearInterval(breathInterval);
            const circle = document.getElementById('breath-circle');
            const text = document.getElementById('breath-text');
            const sub = document.getElementById('breath-subtext');
            const countText = document.getElementById('breath-cycle-count');
            const t = i18n[state.language];
            
            circle.style.animation = 'none';
            text.innerText = t.breath_done;
            text.className = "text-3xl font-extrabold text-white tracking-tight mb-1 transition-all duration-300";
            sub.innerText = t.breath_great;
            countText.innerText = t.done;
            haptic('success');
            
            setTimeout(() => {
                closeBreathingModal();
            }, 2500);
        }

        function toggleBreathPause() {
            const menu = document.getElementById('breath-pause-menu');
            if (menu.classList.contains('hidden')) {
                pauseBreathing();
            } else {
                resumeBreathing();
            }
        }

        function pauseBreathing() {
            clearInterval(breathInterval);
            const circle = document.getElementById('breath-circle');
            const menu = document.getElementById('breath-pause-menu');
            const progress = document.getElementById('breath-progress');
            
            circle.classList.add('paused');
            
            // Freeze progress bar
            const currentWidth = window.getComputedStyle(progress).width;
            progress.style.transition = 'none';
            progress.style.width = currentWidth;

            menu.classList.remove('hidden');
            // Small delay for fade in
            setTimeout(() => {
                menu.classList.remove('opacity-0');
                document.getElementById('breath-menu-card').classList.remove('scale-90');
            }, 10);
            
            haptic('light');
        }

        function resumeBreathing() {
            const circle = document.getElementById('breath-circle');
            const menu = document.getElementById('breath-pause-menu');
            const progress = document.getElementById('breath-progress');
            const t = i18n[state.language];
            
            menu.classList.add('opacity-0');
            document.getElementById('breath-menu-card').classList.add('scale-90');
            
            setTimeout(() => {
                menu.classList.add('hidden');
                circle.classList.remove('paused');
                
                // Resume progress bar
                const totalTime = 60;
                const remaining = totalTime - breathElapsed;
                progress.style.transition = `width ${remaining}s linear`;
                progress.style.width = '100%';
                
                breathInterval = setInterval(currentBreathCycle, 1000);
            }, 300);
            
            haptic('light');
        }

        function exitBreathing() {
            closeBreathingModal();
        }

        function closeBreathingModal() {
            clearInterval(breathInterval);
            clearTimeout(breathTimer);
            const m = document.getElementById('breathing-modal');
            const circle = document.getElementById('breath-circle');
            
            m.classList.add('opacity-0');
            m.classList.add('pointer-events-none');
            
            setTimeout(() => {
                circle.style.animation = 'none';
            }, 500);
        }

        // Основной объект tg уже инициализирован в head, здесь только доп. настройки если нужно
        const PROXY_URL = 'https://focus.enkinvsh.workers.dev';

        function startApp() {
            requestFullscreenMode();
            haptic('medium');
            
            const startScreen = document.getElementById('start-screen');
            startScreen.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
            startScreen.style.opacity = '0';
            startScreen.style.transform = 'scale(1.1)';
            
            setTimeout(() => {
                startScreen.style.display = 'none';
                applyLocalization();
                switchTab('Task');
            }, 400);
        }

        function haptic(type) {
            if (!tg.HapticFeedback) return;
            switch(type) {
                case 'light': tg.HapticFeedback.impactOccurred('light'); break;
                case 'medium': tg.HapticFeedback.impactOccurred('medium'); break;
                case 'success': tg.HapticFeedback.notificationOccurred('success'); break;
                case 'error': tg.HapticFeedback.notificationOccurred('error'); break;
                case 'selection': tg.HapticFeedback.selectionChanged(); break;
            }
        }

        const AVAILABLE_MODELS = ['gemini-3-flash-preview', 'gemini-2.5-pro', 'gemini-2.5-flash'];
        const themes = ['#1e293b', '#052e16', '#042f2e', '#1e1b4b'];
        
        const i18n = {
            en: {
                task: "TASK", long: "LONG", routine: "ROUTINE", settings: "SETTINGS", agent: "AGENT",
                tap: "Tap to speak", modal_settings: "Settings", lang: "Language", theme: "Theme",
                done: "Done", prio: "Priority", lower: "Lower", delete: "Delete",
                quick: "Quick Tasks", main: "MAIN", side: "SIDE",
                agent_ready: "READY", agent_think: "THINKING",
                agent_prompt_lang: "English",
                breath_ready: "Get Ready", breath_relax: "Relax",
                breath_in: "Breathe In", breath_expand: "Expand",
                breath_hold: "Hold", breath_keep: "Keep it",
                breath_out: "Breathe Out", breath_release: "Release",
                breath_done: "Ready to Focus", breath_great: "Great job",
                breath_cycle: "Cycle",
                breath_continue: "Continue", breath_exit: "Exit"
            },
            ru: {
                task: "ЗАДАЧИ", long: "ДОЛГИЕ", routine: "РУТИНА", settings: "НАСТРОЙКИ", agent: "АГЕНТ",
                tap: "Нажми, чтобы добавить", modal_settings: "Настройки", lang: "Язык", theme: "Тема",
                done: "Готово", prio: "Приоритет", lower: "Снизить", delete: "Удалить",
                quick: "Быстрые задачи", main: "ГЛАВНОЕ", side: "ВТОРОЕ",
                agent_ready: "ГОТОВ", agent_think: "ДУМАЕТ",
                agent_prompt_lang: "Russian",
                breath_ready: "Приготовься", breath_relax: "Расслабься",
                breath_in: "Вдох", breath_expand: "Расширяй",
                breath_hold: "Задержка", breath_keep: "Держи",
                breath_out: "Выдох", breath_release: "Отпускай",
                breath_done: "Готов к фокусу", breath_great: "Отлично",
                breath_cycle: "Цикл",
                breath_continue: "Продолжить", breath_exit: "Выйти"
            }
        };

        const state = {
            currentTab: 'Task', tasks: [], currentThemeIndex: 0, isRecording: false,
            language: 'en' 
        };

        function saveTasks() {
            const data = JSON.stringify(state.tasks);
            localStorage.setItem('focusTasks', data);
            if (tg.CloudStorage) {
                tg.CloudStorage.setItem('focusTasks', data, (err) => {
                    if (err) console.error("Cloud Save Error:", err);
                });
            }
        }

        function loadTasks(callback) {
            if (tg.CloudStorage) {
                tg.CloudStorage.getItem('focusTasks', (err, value) => {
                    if (!err && value) {
                        try {
                            state.tasks = JSON.parse(value);
                            callback(); return;
                        } catch(e) {}
                    }
                    const s = localStorage.getItem('focusTasks');
                    if (s) { try { state.tasks = JSON.parse(s); } catch (e) { state.tasks = []; } }
                    callback();
                });
            } else {
                const s = localStorage.getItem('focusTasks');
                if (s) { try { state.tasks = JSON.parse(s); } catch (e) { state.tasks = []; } }
                callback();
            }
        }

        async function runAgent(userText) {
            setAgentStatus('Thinking');
            haptic('medium');
            const targetLang = i18n[state.language].agent_prompt_lang;
            
            const prompt = `You are 'Focus' - a calming, stress-reducing AI task assistant.

CONTEXT:
- Current tab: "${state.currentTab}" (Task = daily actions, Long = long-term goals, Routine = recurring habits)
- User said: "${userText}"
- Language: ${targetLang}

YOUR ROLE:
1. Parse user input into actionable tasks
2. Break complex requests into smaller, manageable steps (reduces overwhelm)
3. Add gentle, supportive micro-tasks when appropriate (e.g., "Take a deep breath", "Stretch for 1 min")
4. Assign smart priorities based on urgency and effort

PRIORITY RULES:
- 1 (MAIN): Critical today, high impact, requires focus
- 2 (SIDE): Important but not urgent, can wait
- 3 (QUICK): Takes <5 min, easy wins, low effort

TITLE RULES (CRITICAL):
- Maximum 3-4 words per title
- Use action verbs: "Buy milk", "Call mom", "Review code"
- No articles, no fluff
- Examples: "Prepare slides" NOT "Prepare the presentation slides for tomorrow"

EXAMPLES:
Input: "I need to prepare presentation for tomorrow and I'm stressed"
Output: [
  {"title": "Deep breaths", "priority": 3},
  {"title": "Outline slides", "priority": 1},
  {"title": "Add content", "priority": 1},
  {"title": "Review & polish", "priority": 2}
]

Input: "Buy groceries"
Output: [{"title": "Buy groceries", "priority": 3}]

OUTPUT FORMAT (JSON array only, no markdown):
[{"title": "2-4 words in ${targetLang}", "original": "${userText}", "type": "${state.currentTab}", "priority": 1-3}]

Generate tasks now:`;
            
            let success = false;
            for (const model of AVAILABLE_MODELS) {
                try {
                    const resp = await fetch(PROXY_URL, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ 
                            model: model, 
                            contents: [{ parts: [{ text: prompt }] }] 
                        })
                    });
                    if (!resp.ok) continue;
                    const data = await resp.json();
                    let text = data.candidates[0].content.parts[0].text;
                    text = text.replace(/```json/gi, '').replace(/```/g, '').trim();
                    const newTasks = JSON.parse(text);
                    newTasks.forEach(t => { t.id = Date.now() + Math.random(); t.completed = false; state.tasks.push(t); });
                    saveTasks(); renderTasks(); setAgentStatus('Ready'); haptic('success');
                    success = true; break;
                } catch (e) { console.error(e); }
            }
            if (!success) { setAgentStatus('Ready'); haptic('error'); }
        }

        function applyLocalization() {
            const t = i18n[state.language];
            document.getElementById('btn-Task').innerText = t.task;
            document.getElementById('btn-Long').innerText = t.long;
            document.getElementById('btn-Routine').innerText = t.routine;
            document.getElementById('lbl-settings').innerText = t.settings;
            document.getElementById('agent-status-text').innerText = t.agent;
            document.getElementById('lbl-tap').innerText = t.tap;
            document.getElementById('lbl-modal-settings').innerText = t.modal_settings;
            document.getElementById('lbl-language').innerText = t.lang;
            document.getElementById('lbl-theme').innerText = t.theme;
            document.getElementById('lbl-done').innerText = t.done;
            document.getElementById('lbl-prio').innerText = t.prio;
            document.getElementById('lbl-lower').innerText = t.lower;
            document.getElementById('lbl-delete').innerText = t.delete;
            document.getElementById('btn-breath-continue').innerText = t.breath_continue;
            document.getElementById('btn-breath-exit').innerText = t.breath_exit;
            const isEn = state.language === 'en';
            document.getElementById('lang-bg').style.transform = isEn ? 'translateX(0%)' : 'translateX(100%)';
            document.getElementById('lang-en').classList.toggle('text-brand-black', isEn);
            document.getElementById('lang-en').classList.toggle('text-gray-400', !isEn);
            document.getElementById('lang-ru').classList.toggle('text-brand-black', !isEn);
            document.getElementById('lang-ru').classList.toggle('text-gray-400', isEn);
            renderTasks();
        }

        function toggleLanguage() {
            state.language = state.language === 'en' ? 'ru' : 'en';
            localStorage.setItem('focusLang', state.language);
            applyLocalization(); haptic('selection');
        }

        function renderTasks() {
            const grid = document.getElementById('task-grid');
            grid.innerHTML = '';
            const active = state.tasks.filter(t => t.type === state.currentTab && !t.completed).sort((a,b) => a.priority - b.priority);
            document.getElementById('empty-state').classList.toggle('hidden', active.length > 0);
            const t = i18n[state.language];
            active.filter(t => t.priority !== 3).forEach(task => grid.appendChild(createCard(task, task.priority === 1 ? 'col-span-2 aspect-[2.1/1] text-xl' : 'col-span-1 aspect-square text-base', t)));
            const p3 = active.filter(t => t.priority === 3);
            if(p3.length > 0) {
                const box = document.createElement('div');
                box.className = 'col-span-2 bg-white/5 rounded-3xl p-4 border border-white/5 mt-2';
                box.innerHTML = `<div class="text-[9px] font-bold text-gray-500 uppercase tracking-widest mb-3 px-1">${t.quick}</div>`;
                p3.forEach(task => {
                    const row = document.createElement('div');
                    row.className = 'bg-white/5 p-3.5 rounded-xl flex justify-between items-center mb-2 last:mb-0 active:scale-95 transition-transform';
                    row.onclick = () => openActionModal(task.id);
                    const span = document.createElement('span');
                    span.className = 'text-sm font-medium text-gray-200 truncate';
                    span.textContent = task.title;
                    const dot = document.createElement('div');
                    dot.className = 'w-1 h-1 rounded-full bg-brand-green/40';
                    row.appendChild(span);
                    row.appendChild(dot);
                    box.appendChild(row);
                });
                grid.appendChild(box);
            }
        }

        function createCard(task, cls, t) {
            const d = document.createElement('div');
            const taskDate = task.createdAt ? new Date(task.createdAt) : new Date();
            const dateStr = taskDate.toLocaleDateString(state.language === 'ru' ? 'ru-RU' : 'en-US', { weekday: 'short' });
            d.className = `task-card bg-white text-brand-black rounded-3xl p-5 relative overflow-hidden flex flex-col justify-between ${cls}`;
            d.onclick = () => openActionModal(task.id);
            
            const header = document.createElement('div');
            header.className = 'flex justify-between items-start opacity-50';
            const badge = document.createElement('span');
            badge.className = 'text-[9px] font-extrabold uppercase tracking-tighter bg-brand-black/10 px-2 py-1 rounded';
            badge.textContent = task.priority === 1 ? t.main : t.side;
            const dateSpan = document.createElement('span');
            dateSpan.className = 'text-[9px] font-bold uppercase';
            dateSpan.textContent = dateStr;
            header.appendChild(badge);
            header.appendChild(dateSpan);
            
            const content = document.createElement('div');
            content.className = 'z-10';
            const title = document.createElement('h3');
            title.className = 'font-extrabold leading-tight line-clamp-3';
            title.textContent = task.title;
            content.appendChild(title);
            
            const glow = document.createElement('div');
            glow.className = 'absolute bottom-0 right-0 w-24 h-24 bg-brand-green opacity-20 rounded-full blur-2xl translate-y-8 translate-x-8';
            
            d.appendChild(header);
            d.appendChild(content);
            d.appendChild(glow);
            return d;
        }

        function switchTab(n) {
            state.currentTab = n;
            document.querySelectorAll('nav button').forEach(b => b.classList.replace('text-brand-black','text-gray-400'));
            document.getElementById(`btn-${n}`).classList.replace('text-gray-400','text-brand-black');
            const offsets = { 'Task': '0%', 'Long': '100%', 'Routine': '200%' };
            document.getElementById('tab-indicator').style.transform = `translateX(${offsets[n]})`;
            renderTasks(); haptic('selection');
        }

        let touchStart = { x: 0, y: 0 };
        document.body.addEventListener('touchstart', e => { touchStart.x = e.changedTouches[0].screenX; touchStart.y = e.changedTouches[0].screenY; }, {passive: true});
        document.body.addEventListener('touchend', e => {
            const diffX = e.changedTouches[0].screenX - touchStart.x;
            const diffY = e.changedTouches[0].screenY - touchStart.y;
            if (Math.abs(diffX) > 50 && Math.abs(diffX) > Math.abs(diffY)) {
                if (diffX > 0) { if(state.currentTab==='Routine') switchTab('Long'); else if(state.currentTab==='Long') switchTab('Task'); }
                else { if(state.currentTab==='Task') switchTab('Long'); else if(state.currentTab==='Long') switchTab('Routine'); }
            }
        }, {passive: true});

        function openActionModal(id) {
            state.selectedTaskId = id;
            const t = state.tasks.find(x => x.id === id);
            document.getElementById('modal-task-title').textContent = t.title;
            document.getElementById('modal-original-command').textContent = `"${t.original}"`;
            const m = document.getElementById('action-modal');
            m.classList.remove('hidden');
            setTimeout(() => { m.classList.remove('opacity-0', 'pointer-events-none'); document.getElementById('action-sheet').classList.remove('translate-y-full'); }, 10);
            haptic('light');
        }

        function closeModal() {
            document.getElementById('action-sheet').classList.add('translate-y-full');
            const m = document.getElementById('action-modal');
            m.classList.add('opacity-0', 'pointer-events-none');
            setTimeout(() => m.classList.add('hidden'), 300);
        }

        function taskAction(action) {
            const idx = state.tasks.findIndex(t => t.id === state.selectedTaskId);
            if(idx > -1) {
                if(action === 'delete') state.tasks.splice(idx,1);
                else if(action === 'done') state.tasks[idx].completed = true;
                else if(action === 'up' && state.tasks[idx].priority > 1) state.tasks[idx].priority--;
                else if(action === 'down' && state.tasks[idx].priority < 3) state.tasks[idx].priority++;
                haptic('success');
            }
            saveTasks(); renderTasks(); closeModal();
        }

        function toggleSettingsModal() {
            const m = document.getElementById('settings-modal');
            const isHidden = m.classList.contains('hidden');
            if (isHidden) { m.classList.remove('hidden'); setTimeout(() => { m.classList.remove('opacity-0', 'pointer-events-none'); }, 10); }
            else { m.classList.add('opacity-0', 'pointer-events-none'); setTimeout(() => m.classList.add('hidden'), 200); }
        }

        function setTheme(idx) {
            state.currentThemeIndex = idx;
            const color = themes[idx];
            document.getElementById('app-body').style.backgroundColor = color;
            tg.setHeaderColor(color); tg.setBackgroundColor(color);
            localStorage.setItem('focusThemeIndex', idx); haptic('selection');
        }

        // AUDIO RECORDING (MediaRecorder for iOS compatibility)
        let mediaRecorder = null;
        let audioChunks = [];
        let audioContext = null;
        let analyser = null;
        let audioStream = null;
        let silenceCheckInterval = null;
        let recordingTimeout = null;
        let silenceStart = null;
        const SILENCE_THRESHOLD = 0.01;
        const SILENCE_DURATION = 2000; // 2 seconds of silence to auto-stop
        const MAX_RECORDING_TIME = 8000; // 8 seconds max
        
        async function initAudioRecording() {
            try {
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Setup Web Audio API for silence detection
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 512;
                const source = audioContext.createMediaStreamSource(audioStream);
                source.connect(analyser);
                
                // Prefer webm for smaller size, fallback to mp4 for iOS
                const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4';
                mediaRecorder = new MediaRecorder(audioStream, { mimeType });
                
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) audioChunks.push(e.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                    audioChunks = [];
                    await sendAudioToBackend(audioBlob);
                };
                
                return true;
            } catch (e) {
                console.error('Microphone access denied:', e);
                return false;
            }
        }
        
        function checkSilence() {
            if (!analyser || !state.isRecording) return;
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteTimeDomainData(dataArray);
            
            // Calculate RMS (Root Mean Square) for volume level
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                const sample = (dataArray[i] - 128) / 128;
                sum += sample * sample;
            }
            const rms = Math.sqrt(sum / dataArray.length);
            
            if (rms < SILENCE_THRESHOLD) {
                if (!silenceStart) silenceStart = Date.now();
                else if (Date.now() - silenceStart >= SILENCE_DURATION) {
                    stopRecording();
                }
            } else {
                silenceStart = null;
            }
        }
        
        function startProgressRing() {
            const circle = document.getElementById('progress-circle');
            circle.classList.remove('animating');
            void circle.offsetWidth; // Force reflow
            circle.classList.add('animating');
        }
        
        function stopProgressRing() {
            const circle = document.getElementById('progress-circle');
            const computedStyle = getComputedStyle(circle);
            const currentOffset = computedStyle.strokeDashoffset;
            circle.classList.remove('animating');
            circle.style.strokeDashoffset = currentOffset;
            // Reset after short delay
            setTimeout(() => {
                circle.style.strokeDashoffset = '226';
            }, 300);
        }
        
        function startRecording() {
            if (!mediaRecorder || mediaRecorder.state === 'recording') return;
            audioChunks = [];
            silenceStart = null;
            
            // Resume AudioContext if suspended (iOS requirement)
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            mediaRecorder.start();
            state.isRecording = true;
            haptic('medium');
            
            // Visual feedback
            document.getElementById('voice-btn').classList.replace('bg-brand-green','bg-brand-red');
            document.getElementById('mic-icon').classList.add('hidden');
            document.getElementById('waveform').classList.remove('hidden');
            
            // Start progress ring animation
            startProgressRing();
            
            // Start silence detection
            silenceCheckInterval = setInterval(checkSilence, 100);
            
            // Max recording timeout
            recordingTimeout = setTimeout(() => {
                if (state.isRecording) stopRecording();
            }, MAX_RECORDING_TIME);
        }
        
        function stopRecording() {
            if (!mediaRecorder || mediaRecorder.state !== 'recording') return;
            
            // Clear timers
            if (silenceCheckInterval) {
                clearInterval(silenceCheckInterval);
                silenceCheckInterval = null;
            }
            if (recordingTimeout) {
                clearTimeout(recordingTimeout);
                recordingTimeout = null;
            }
            
            mediaRecorder.stop();
            state.isRecording = false;
            
            // Visual feedback
            document.getElementById('voice-btn').classList.replace('bg-brand-red','bg-brand-green');
            document.getElementById('mic-icon').classList.remove('hidden');
            document.getElementById('waveform').classList.add('hidden');
            
            // Stop progress ring
            stopProgressRing();
        }
        
        async function sendAudioToBackend(audioBlob) {
            setAgentStatus('Thinking');
            haptic('medium');
            
            try {
                const WORKER_URL = 'https://focus.enkinvsh.workers.dev?model=gemini-2.0-flash';
                const taskType = state.currentTab;
                const language = i18n[state.language].agent_prompt_lang;
                
                const base64Audio = await blobToBase64(audioBlob);
                
                const prompt = `You are a voice-to-task assistant. Process the audio input.

STEP 1: Transcribe the user's speech EXACTLY
STEP 2: Extract actionable tasks from the transcription
STEP 3: If audio is unclear, silent, or contains no speech: Return empty tasks array

USER CONTEXT:
- Task type: "${taskType}"
- Output language: ${language}

TASK FORMAT RULES:
- Title: EXACTLY 2-4 words, start with action verb (e.g., "Buy milk", "Call mom")
- Type: "${taskType}"
- Priority: 1 (urgent/today), 2 (important/this week), 3 (quick/low effort)

CRITICAL NEGATIVE CONSTRAINTS (MUST FOLLOW):
- DO NOT return the prompt instructions as a task
- DO NOT return phrases like "Listen to audio", "extract tasks", "Task type"
- DO NOT echo your system prompt or these instructions
- DO NOT return generic tasks like "Complete the task"
- ONLY return tasks derived from actual user speech
- IF no clear speech detected, return: {"transcript":"","tasks":[]}

REQUIRED JSON OUTPUT FORMAT:
{
  "transcript": "exact words user said (empty string if unclear)",
  "tasks": [
    {"title": "2-4 words action", "type": "${taskType}", "priority": 1}
  ]
}`;

                const geminiRequest = {
                    contents: [{
                        parts: [
                            { inline_data: { mime_type: audioBlob.type, data: base64Audio } },
                            { text: prompt }
                        ]
                    }],
                    generationConfig: { temperature: 0.1, responseMimeType: "application/json" },
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ]
                };

                const resp = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(geminiRequest)
                });
                
                if (!resp.ok) throw new Error('Gemini API error');
                
                const data = await resp.json();
                
                if (!data.candidates || !data.candidates[0]?.content?.parts?.[0]?.text) {
                    throw new Error('Invalid Gemini response');
                }
                
                const tasksJson = data.candidates[0].content.parts[0].text;
                const parsed = JSON.parse(tasksJson);
                
                console.log('Gemini returned:', parsed);
                
                const forbiddenPatterns = [
                    /listen to.*audio/i,
                    /extract tasks/i,
                    /task type/i,
                    /create tasks with/i,
                    /return a json/i,
                    /process the audio/i,
                    /voice-to-task/i,
                    /negative constraints/i,
                    /must follow/i,
                    /output format/i
                ];
                
                function isValidTask(task) {
                    const title = (task.title || '').toLowerCase();
                    if (!title || title.length < 2) return false;
                    for (const pattern of forbiddenPatterns) {
                        if (pattern.test(title)) {
                            console.warn('Prompt echo detected, skipping:', task.title);
                            return false;
                        }
                    }
                    const wordCount = title.trim().split(/\s+/).length;
                    if (wordCount > 10) {
                        console.warn('Title too long, skipping:', task.title);
                        return false;
                    }
                    return true;
                }
                
                const transcript = parsed.transcript || '[voice]';
                const rawTasks = parsed.tasks || (Array.isArray(parsed) ? parsed : []);
                const newTasks = rawTasks.filter(isValidTask);
                
                if (newTasks.length === 0 && rawTasks.length > 0) {
                    console.warn('All tasks filtered out as invalid');
                    haptic('error');
                    setAgentStatus('Ready');
                    return;
                }
                
                newTasks.forEach(t => {
                    const priority = typeof t.priority === 'number' ? t.priority : 
                                     t.priority === 'high' || t.priority === 'urgent' ? 1 :
                                     t.priority === 'low' || t.priority === 'quick' ? 3 : 2;
                    state.tasks.push({
                        id: Date.now() + Math.random(),
                        title: t.title || t.name || t.task || 'New task',
                        original: transcript,
                        type: t.type || taskType,
                        priority: priority,
                        completed: false,
                        createdAt: Date.now()
                    });
                });
                
                saveTasks();
                renderTasks();
                setAgentStatus('Ready');
                haptic('success');
            } catch (e) {
                console.error('Audio API error:', e);
                setAgentStatus('Ready');
                haptic('error');
            }
        }
        
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        
        // Initialize voice button
        document.getElementById('voice-btn').onclick = async () => {
            if (!mediaRecorder) {
                const ok = await initAudioRecording();
                if (!ok) {
                    haptic('error');
                    return;
                }
            }
            state.isRecording ? stopRecording() : startRecording();
        };

        function setAgentStatus(status) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('agent-status-text');
            const t = i18n[state.language];
            if (status === 'Thinking') { dot.className = "w-2 h-2 rounded-full bg-blue-500 animate-bounce"; text.innerText = t.agent_think; }
            else { dot.className = "w-2 h-2 rounded-full bg-brand-green animate-pulse"; text.innerText = t.agent_ready; }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('focusThemeIndex'); if(savedTheme) setTheme(parseInt(savedTheme));
            const savedLang = localStorage.getItem('focusLang'); if(savedLang) state.language = savedLang;
            loadTasks(() => {});
        });
    </script>
</body>
</html>